<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <title>War</title>
</head>
<body>

    <header>
        <h1>War</h1>
    </header>

    <main>
        <article>
            <a id="collapse">collapse instructions</a>
            <h2>Instructions</h2>
            <p>Each player turns over the top card of their deck. The player with the higher ranked card takes both and puts them their deck. If the cards have the same rank, it is called "war". Each player puts another card facedown and another faceup, and play based on the new cards, repeating until one card is a higher rank, and then the player with the higher ranked card takes all of the accumulated cards from the center.</p>
            <p>You win by having all of the cards.</p>
        </article>

        <article id="game">

            <button id="start">Start the Game</button>
            <button id="next" class="hide">next round</button>
            <article id="message"></article>

            <div id="p1deckarea">
                <img src="images/cardback.svg" width="225" height="300">
                <p>player 1's deck</p>
                <p>number of cards: <span id="p1num"></span></p>
                <button id="p1play" class="hide">play a card</button>
            </div>

            <div id="playedcardsarea">
                <img id="p1" src="images/blankspace.svg" width="225" height="300">
                <img id="p2" src="images/blankspace.svg" width="225" height="300">
                <img id="war" src="images/blankspace.svg" width="225" height="300">
            </div>

            <div id="p2deckarea">
                <img src="images/cardback.svg" width="225" height="300">
                <p>player 2's deck</p>
                <p>number of cards: <span id="p2num"></span></p>
                <button id="p2play" class="hide">play a card</button>
            </div>

        </article>

        

    </main>

    <footer>
        <a href="https://validator.w3.org/check?uri=referer">Valid HTML</a>
        <a href="https://jigsaw.w3.org/css-validator/check/referer">Valid CSS</a>
    </footer>

    <script>

        // areas
        var gameArea = document.getElementById("game");
        var p1deckArea = document.getElementById("p1deckarea");
        var p2deckArea = document.getElementById("p2deckarea");
        var playedcardsArea = document.getElementById("playedcardsarea");
        var msgArea = document.getElementById("message");

        // buttons
        var p1play = document.getElementById("p1play");
        var p2play = document.getElementById("p2play");
        var start = document.getElementById("start");
        var next = document.getElementById("next");

        // images
        var p1Card = document.getElementById("p1");
        var warCards = document.getElementById("war")
        var p2Card = document.getElementById("p2");


        var game = {
            player1: {
                numCards: 0,
                numCardsSpan: document.getElementById("p1num"),
                cardArray: [],
            },
            player2: {
                numCards: 0,
                numCardsSpan: document.getElementById("p2num"),
                cardArray: [],
            },
            pile1: [],
            pile2: []
        };


        // start the game
        start.addEventListener("click", function(){
            // clear message area
            msgArea.innerHTML = "";
            
            // deal cards
            fillAndShuffle();
            // console.log(game.player1.cardArray);
            // console.log(game.player2.cardArray);
            // set up buttons
            start.innerHTML = "Restart Game";
            p1play.setAttribute("class", "show");
            p2play.setAttribute("class", "show");
            next.setAttribute("class", "show");
            next.disabled = false;
            // reset played card display
            p1Card.src = `images/blankspace.svg`;
            p2Card.src = `images/blankspace.svg`;
            

        });

        function fillAndShuffle(){
            const array = [];
            const SIZE = 10;
            // fill with 52 cards
            for (let i = 0; i < SIZE; i++) {
                array[i] = i+1;
            }
            // 52 random swaps
            for (let i = 0; i < SIZE; i++) {
                const rand = Math.ceil(Math.random()*SIZE);
                const temp = array[i];
                array[i] = array[rand];
                array[rand] = temp;
            }
            // partition to players
            for (let i=0; i<SIZE/2; i++) {
                game.player1.cardArray[i] = array[i];
                game.player2.cardArray[i] = array[i+SIZE/2];
            }
            game.player1.numCards = SIZE/2;
            game.player2.numCards = SIZE/2;

            // game.player1.numCardsSpan.innerHTML = `${game.player1.numCards}`;
            // game.player2.numCardsSpan.innerHTML = `${game.player2.numCards}`;
            document.getElementById("p1num").innerHTML = `${game.player1.numCards}`;
            document.getElementById("p2num").innerHTML = `${game.player2.numCards}`;
        }

        function isGameOver() {
            return game.player1.cardArray.length == 0 || game.player2.cardArray.length == 0;
        }
        function getWinner() {
            return game.player1.cardArray.length == 0 ? 2 : 1;
        }

        function evaluate() {
            msgArea.innerHTML = "";
            const card1val = cardNumToRank(game.pile1[game.pile1.length-1]);
            const card2val = cardNumToRank(game.pile2[game.pile2.length-1]);
            
            console.log("p1 " + card1val);
            console.log("p2 " + card2val);

            if (card1val < card2val) {
                msgArea.innerHTML += "<p>player two wins this round!</p>";
                for (let i = 0; i < game.pile1.length; i++) {
                    game.player2.cardArray.unshift(game.pile1.pop());
                    game.player2.numCards++;
                }
                for (let i = 0; i < game.pile2.length; i++) {
                    game.player2.cardArray.unshift(game.pile2.pop());
                    game.player2.numCards++;
                }
                console.log("to p2");
            }
            else if (card1val > card2val) {
                msgArea.innerHTML += "<p>player one wins this round!</p>";
                for (let i = 0; i < game.pile1.length; i++) {
                    game.player1.cardArray.unshift(game.pile1.pop());
                    game.player1.numCards++;
                }
                for (let i = 0; i < game.pile2.length; i++) {
                    game.player1.cardArray.unshift(game.pile2.pop());
                    game.player1.numCards++;
                }
                console.log("to p1");
            }
            // war scenario
            else {
                msgArea.innerHTML += "<p>THIS MEANS WAR!</p>"
                console.log("equal");
                setTimeout(function(){
                    moveCardP1War();
                    moveCardP2War();
                    playCardNoShow(game.player1);
                    playCardNoShow(game.player2);

                    // play faceup cards
                    setTimeout(function(){
                        moveCardP1();
                        moveCardP2();
                        playCardAndShow(game.player1);
                        playCardAndShow(game.player2);
                    }, 500);
                    
                    evaluate();
                
                } ,1000);
                
            }
            game.player1.numCardsSpan.innerHTML = `${game.player1.numCards}`;
            game.player2.numCardsSpan.innerHTML = `${game.player2.numCards}`;
            console.log(game.player1.numCards);
            console.log(game.player2.numCards);

        }


        function moveCardP1() {
            p1deckArea.innerHTML += '<img src="images/cardback.svg" id="animatethis1" class="transition" width="225" height="300">';
            document.getElementById("animatethis1").style.left = "238px";
            setTimeout(function(){
                p1deckArea.removeChild(document.getElementById("animatethis1"));
            }, 500);
        }
        function moveCardP2() {
            p2deckArea.innerHTML += '<img src="images/cardback.svg" id="animatethis2" class="transition" width="225" height="300">';
            document.getElementById("animatethis2").style.transition = "all 0.5s";
            document.getElementById("animatethis2").style.left = "-238px";
            setTimeout(function(){
                p2deckArea.removeChild(document.getElementById("animatethis2"));
            }, 500);
        }
        function moveCardP1War() {
            p1deckArea.innerHTML += '<img src="images/cardback.svg" id="animatethis11" class="transition" width="225" height="300">';
            document.getElementById("animatethis11").style.top = "-8px";
            document.getElementById("animatethis11").style.left = "375px";
            setTimeout(function(){
                p1deckArea.removeChild(document.getElementById("animatethis11"));
            }, 500);
        }
        function moveCardP2War() {
            p2deckArea.innerHTML += '<img src="images/cardback.svg" id="animatethis22" class="transition" width="225" height="300">';
            document.getElementById("animatethis22").style.top = "-8px";
            document.getElementById("animatethis22").style.left = "-375px";
            setTimeout(function(){
                p2deckArea.removeChild(document.getElementById("animatethis22"));
            }, 500);
        }

        function playCardAndShow(player) {
            
            // console.log(player.cardArray);
            let topCard = player.cardArray.pop();
            // console.log(topCard);

            if (player == game.player1) {
                game.pile1.push(topCard);
                if (topCard < 10) {topCard = `0${topCard}`;}
                console.log(topCard);
                p1Card.src = `images/cards-${topCard}.svg`;
            }
            else {
                game.pile2.push(topCard);
                if (topCard < 10) {topCard = `0${topCard}`;}
                p2Card.src = `images/cards-${topCard}.svg`;
            }
            player.numCards--;
        }

        function playCardNoShow(player) {

            let topCard = player.cardArray.pop();

            if (player == game.player1) {
                game.pile1.push(topCard);
            }
            else {
                game.pile2.push(topCard);
            }
            player.numCards--;
        }
        
        next.addEventListener('click', function(){
            nextRound();
        });

        function nextRound() {
            next.disabled = true;
            if (!isGameOver()){
                moveCardP1();
                moveCardP2();
                playCardAndShow(game.player1);
                playCardAndShow(game.player2);

                evaluate();
                setTimeout(function(){
                    next.disabled = false;
                }, 500);
            }
            else {
                const winner = getWinner();
                msgArea.innerHTML = `<p>Player ${winner} won!</p>`;
                start.innerHTML = "Play Again?";
            }

            document.getElementById("p1num").innerHTML = `${game.player1.numCards}`;
            document.getElementById("p2num").innerHTML = `${game.player2.numCards}`;
        }


        function cardNumToRank(num) {
            while (num > 13) {
                num -= 13;
            }
            return num;
        }

        document.getElementById("collapse").addEventListener('click', function(){
            const article = document.querySelector("article");
            for (let i = 1; i < article.children.length; i++) {
                article.children[i].setAttribute("class", "hide");
            }
        });





    </script>
    
</body>
</html>